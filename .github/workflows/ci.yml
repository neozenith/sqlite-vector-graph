name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  # ── Code Quality ───────────────────────────────────────
  quality:
    runs-on: ubuntu-22.04
    name: Code Quality
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Install Python dev tools
        run: pip install ruff mypy

      - name: Install Node.js dependencies
        run: npm --prefix npm ci

      - name: Lint C (clang-format)
        run: |
          sudo apt-get install -y clang-format
          make lint-c

      - name: Lint Python (ruff)
        run: |
          ruff check .
          ruff format --check .

      - name: Lint TypeScript (biome)
        run: make lint-js

      - name: Type-check Python (mypy)
        run: mypy sqlite_muninn/

      - name: Type-check TypeScript (tsc)
        run: make typecheck-js

  # ── Build & Test (All Platforms) ─────────────────────────
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-22.04
            name: Linux x86_64
            ext: so
          - os: ubuntu-22.04-arm
            name: Linux ARM64
            ext: so
          - os: macos-15
            name: macOS Universal
            ext: dylib
          - os: windows-2022
            name: Windows x86_64
            ext: dll
    runs-on: ${{ matrix.os }}
    name: Build (${{ matrix.name }})
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      # ── Cache llama.cpp build ───────────────────────────
      - uses: actions/cache@v4
        with:
          path: vendor/llama.cpp/build
          key: llama-${{ runner.os }}-${{ runner.arch }}-${{ hashFiles('.gitmodules') }}

      # ── Unix build ──────────────────────────────────────
      - name: Build extension (Unix)
        if: runner.os != 'Windows'
        run: make all

      - name: Run C unit tests
        if: runner.os != 'Windows'
        run: |
          sudo apt-get install -y libsqlite3-dev 2>/dev/null || true
          make test

      - name: SQLite CLI smoke test
        if: runner.os != 'Windows'
        run: |
          if [ "$(uname -s)" = "Darwin" ]; then
            SQLITE3="$(brew --prefix sqlite)/bin/sqlite3"
          else
            SQLITE3="sqlite3"
          fi
          "$SQLITE3" :memory: ".load ./build/muninn" "SELECT 1"

      # ── Windows build ───────────────────────────────────
      - name: Setup MSVC
        if: runner.os == 'Windows'
        uses: ilammy/msvc-dev-cmd@v1

      - name: Build extension (Windows)
        if: runner.os == 'Windows'
        shell: cmd
        run: scripts\build_windows.bat

      # ── Python integration tests ────────────────────────
      - uses: actions/setup-python@v5
        if: runner.os != 'Windows'
        with:
          python-version: "3.13"

      - uses: actions/cache@v4
        if: runner.os != 'Windows'
        with:
          path: models
          key: gguf-test-models

      - name: Python integration tests
        if: runner.os != 'Windows'
        run: |
          pip install pytest pytest-cov
          pip install pysqlite3-binary 2>/dev/null || pip install pysqlite3
          python -m pytest pytests/ -v

      # ── Node.js tests ──────────────────────────────────
      - uses: actions/setup-node@v4
        if: runner.os != 'Windows'
        with:
          node-version: "22"

      - name: TypeScript tests
        if: runner.os != 'Windows'
        run: |
          npm --prefix npm ci
          npm --prefix npm test

      # ── Upload artifact ─────────────────────────────────
      - uses: actions/upload-artifact@v4
        with:
          name: muninn-${{ matrix.name }}
          path: build/muninn.${{ matrix.ext }}

  # ── macOS Universal Binary ──────────────────────────────
  build-macos-universal:
    runs-on: macos-15
    name: Build (macOS Universal Binary)
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Build arm64
        run: make ARCH=arm64 all

      - name: Save arm64 binary
        run: cp build/muninn.dylib muninn_arm64.dylib

      - name: Build x86_64
        run: make clean all ARCH=x86_64

      - name: Create universal binary
        run: |
          lipo -create muninn_arm64.dylib build/muninn.dylib -output build/muninn_universal.dylib
          mv build/muninn_universal.dylib build/muninn.dylib
          rm -f muninn_arm64.dylib
          lipo -info build/muninn.dylib

      - uses: actions/upload-artifact@v4
        with:
          name: muninn-macos-universal
          path: build/muninn.dylib

  # ── Sanitizers (Linux only) ──────────────────────────────
  sanitize:
    runs-on: ubuntu-22.04
    strategy:
      matrix:
        sanitizer:
          - name: ASan+UBSan
            flags: "-fsanitize=address,undefined -fno-sanitize-recover=all"
    name: Sanitize (${{ matrix.sanitizer.name }})
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - uses: actions/cache@v4
        with:
          path: vendor/llama.cpp/build
          key: llama-${{ runner.os }}-${{ runner.arch }}-${{ hashFiles('.gitmodules') }}

      - name: Install SQLite dev headers
        run: sudo apt-get install -y libsqlite3-dev

      - name: Build and test with ${{ matrix.sanitizer.name }}
        run: |
          CC=clang make test \
            CFLAGS_EXTRA="${{ matrix.sanitizer.flags }} -g -O1 -fno-omit-frame-pointer"

  # ── Amalgamation ─────────────────────────────────────────
  amalgamation:
    runs-on: ubuntu-22.04
    name: Amalgamation
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Create amalgamation
        run: make amalgamation

      - name: Verify amalgamation compiles (syntax check only)
        run: |
          # The amalgamation includes llama.h which requires llama.cpp headers.
          # We verify it compiles with the vendored headers available.
          cc -O2 -fPIC -shared dist/muninn.c -o dist/muninn.so \
            -Ivendor/llama.cpp/include -Ivendor/llama.cpp/ggml/include \
            -lm 2>&1 || echo "Note: link errors expected without llama.cpp libs"
          ls -la dist/muninn.c dist/muninn.h

      - uses: actions/upload-artifact@v4
        with:
          name: amalgamation
          path: |
            dist/muninn.c
            dist/muninn.h

  # ── Package Install Tests ────────────────────────────────
  package-install:
    runs-on: ubuntu-22.04
    name: Package Install Tests
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - uses: actions/cache@v4
        with:
          path: vendor/llama.cpp/build
          key: llama-${{ runner.os }}-${{ runner.arch }}-${{ hashFiles('.gitmodules') }}

      - name: Install SQLite dev headers
        run: sudo apt-get install -y libsqlite3-dev

      - name: Build extension
        run: make all

      - uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - uses: actions/setup-node@v4
        with:
          node-version: "22"

      - uses: astral-sh/setup-uv@v4

      - name: Build npm package
        run: |
          npm --prefix npm ci
          npm --prefix npm run build

      - name: Run install integration tests
        run: |
          pip install pytest
          pip install pysqlite3-binary 2>/dev/null || pip install pysqlite3
          python -m pytest pytests/test_install.py -v -m integration --override-ini="addopts="

  # ── WASM Build ───────────────────────────────────────────
  wasm:
    runs-on: ubuntu-22.04
    name: WASM Build
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - uses: actions/cache@v4
        with:
          path: vendor/llama.cpp/build-wasm
          key: llama-wasm-${{ hashFiles('.gitmodules') }}

      - name: Setup Emscripten
        uses: mymindstorm/setup-emsdk@v14

      - name: Build WASM
        run: make -C wasm dist

      - uses: actions/upload-artifact@v4
        with:
          name: wasm
          path: |
            dist/nodejs/platforms/wasm/muninn_sqlite3.js
            dist/nodejs/platforms/wasm/muninn_sqlite3.wasm
